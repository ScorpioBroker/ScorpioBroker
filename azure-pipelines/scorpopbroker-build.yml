trigger:
- quarkus-release/4.1.15

variables:
  # tag: java-4.1.15-$(Build.BuildId)
  javaKafkaTag: java-kafka-4.1.15-$(Build.BuildId)
  SelfHostedPoolName: iot-shared-ubuntu-20.04

pool:
  name: $(SelfHostedPoolName)

steps:

- task: Docker@2
  displayName: Login to ACR docker registry
  inputs:    
    command: login
    containerRegistry: iotsharedacr-registry-ServiceConnection

- task: Maven@3
  inputs:
    mavenPomFile: 'pom.xml'
    mavenOptions: '-Xmx3072m'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '1.17'
    jdkArchitectureOption: 'x64'
    publishJUnitResults: true
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
    goals: 'clean package'
    oprtions: '-DskipTests -Dmaven.test.skip=true -Dkafka -Pkafka -Ddocker -Ddocker-tag=scorpiobroker/all-in-one-runner:$(tag) -Dos=java -Dquarkus.profile=kafka -B'
    # options: '-Dos=java -B -Dmaven.test.skip=true'

# - task: Docker@2
#   displayName: Build and push docker image for AllInOneRunner
#   inputs:    
#     command: buildAndPush
#     buildContext: AllInOneRunner
#     dockerfile: AllInOneRunner/src/main/resources/dockerfiles/dockerfile-java
#     repository: scorpiobroker/all-in-one-runner
#     tags: |
#       $(javaKafkaTag)


- script: docker tag scorpiobroker/all-in-one-runner:$(javaKafkaTag) iotsharedacr.azurecr.io/scorpiobroker/all-in-one-runner:$(javaKafkaTag)
- script: docker tag scorpiobroker/all-in-one-runner:$(javaKafkaTag) iotsharedacr.azurecr.io/scorpiobroker/all-in-one-runner:java-kafka-latest

- script: docker images

- script: docker push iotsharedacr.azurecr.io/scorpiobroker/all-in-one-runner:$(javaKafkaTag)
- script: docker push iotsharedacr.azurecr.io/scorpiobroker/all-in-one-runner:java-kafka-latest

